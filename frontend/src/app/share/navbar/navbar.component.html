<nav class="navbar">
  <div class="navbar-container">
    <!-- 1. LOGO -->
    <a routerLink="/" class="navbar-brand" (click)="closeMobileMenu()">
      <span class="brand-logo">01</span>
      <span class="brand-name">Blog</span>
    </a>

    <!-- 2. DESKTOP ACTIONS -->
    <div class="navbar-desktop">
      <div class="navbar-actions">
        <app-theme-toggle></app-theme-toggle>

        <!-- A) GUEST VIEW -->
        @if (!isLoggedIn()) {
        <a mat-button routerLink="/auth/login" class="nav-link">Sign in</a>
        <a mat-flat-button color="primary" routerLink="/auth/register" class="nav-btn-primary">
          Get started
        </a>
        }

        <!-- B) LOGGED IN VIEW -->
        @if (isLoggedIn()) {
        <a mat-icon-button routerLink="/me/saved" matTooltip="Library" class="action-icon">
          <mat-icon>bookmarks</mat-icon>
        </a>

        <!-- USER ACTIONS (Non-Admin) -->
        @if (!isAdmin()) {
        <a mat-icon-button routerLink="/me/drafts" matTooltip="Your Draft Stories" class="action-icon">
          <mat-icon>description</mat-icon>
        </a>

        <a mat-button routerLink="/new-story" class="write-link">
          <mat-icon fontIcon="edit_square" class="write-icon"></mat-icon>
          <span>Write</span>
        </a>

        <!-- NOTIFICATIONS -->
        <button mat-icon-button [matMenuTriggerFor]="notificationMenu" class="action-icon">
          <mat-icon
            [matBadge]="unreadCount() > 0 ? (unreadCount() > 9 ? '9+' : unreadCount()) : null"
            matBadgeColor="warn"
            matBadgeSize="small"
          >
            notifications_none
          </mat-icon>
        </button>
        }

        <!-- ADMIN DASHBOARD -->
        @else {
        <a mat-button routerLink="/admin/dashboard">Dashboard</a>
        }

        <!-- USER PROFILE TRIGGER -->
        <button class="avatar-btn" [matMenuTriggerFor]="userMenu">
          <img [src]="avatarUrl() || '/default-avatar.jpg'" class="nav-avatar" [alt]="username()" />
        </button>
        }
      </div>
    </div>

    <!-- 3. MOBILE CONTROLS -->
    <div class="navbar-mobile-controls">
      <app-theme-toggle></app-theme-toggle>

      <button mat-icon-button (click)="toggleMobileMenu()">
        <mat-icon>{{ isMobileMenuOpen() ? 'close' : 'menu' }}</mat-icon>
      </button>
    </div>
  </div>

  <!-- 4. MOBILE MENU OVERLAY -->
  <div class="mobile-menu" [class.open]="isMobileMenuOpen()">
    <div class="mobile-menu-content">
      @if (!isLoggedIn()) {
      <a mat-button routerLink="/auth/login" (click)="closeMobileMenu()">Sign in</a>
      <a mat-flat-button color="primary" routerLink="/auth/register" (click)="closeMobileMenu()">
        Get started
      </a>
      } @else {
      <!-- User Info Mobile -->
      <div
        class="mobile-user-profile"
        [routerLink]="['/profile', userId()]"
        (click)="closeMobileMenu()"
      >
        <img [src]="avatarUrl() || '/default-avatar.jpg'" class="mobile-avatar" />
        <span class="mobile-username">{{ username() }}</span>
      </div>

      @if (!isAdmin()) {
      <a mat-button class="mobile-link" routerLink="/new-story" (click)="closeMobileMenu()">
        <mat-icon>edit</mat-icon> Write a Story
      </a>
      <a mat-button class="mobile-link" routerLink="/me/drafts" (click)="closeMobileMenu()">
        <mat-icon>description</mat-icon> My Drafts
      </a>
      <button mat-button class="mobile-link" [matMenuTriggerFor]="notificationMenu">
        <mat-icon [matBadge]="unreadCount() || null" matBadgeColor="warn">notifications</mat-icon>
        Notifications
      </button>
      } @else {
      <a mat-button routerLink="/admin/dashboard" (click)="closeMobileMenu()">Dashboard</a>
      }

      <mat-divider class="mobile-divider"></mat-divider>
      <button mat-button color="warn" (click)="logout()">Sign out</button>
      }
    </div>
  </div>

  <div
    class="mobile-overlay"
    [class.visible]="isMobileMenuOpen()"
    (click)="closeMobileMenu()"
  ></div>

  <!-- ============================================================== -->
  <!-- SHARED MENUS -->
  <!-- ============================================================== -->

  <!-- 1. NOTIFICATION MENU -->
  <mat-menu #notificationMenu="matMenu" class="custom-menu notif-menu" xPosition="before">
    <div class="menu-header">Notifications</div>
    <div class="menu-scroll-content">
      @if (notifications().length === 0) {
      <div class="empty-state">No notifications yet.</div>
      } @else { @for (notif of notifications(); track notif.id) {
      <button
        mat-menu-item
        class="notif-item"
        [class.unread]="!notif.read"
        (click)="markRead(notif)"
        [routerLink]="['/posts', notif.post.id]"
      >
        <div class="notif-content">
          <p class="notif-msg">{{ notif.message }}</p>
          <span class="notif-date">{{ notif.createdAt | date : 'short' }}</span>
        </div>
      </button>
      } }
    </div>
  </mat-menu>

  <!-- 2. USER MENU -->
  <mat-menu #userMenu="matMenu" class="custom-menu user-menu" xPosition="before">
    <div class="user-info-header">
      <p class="u-name">{{ username() }}</p>
      <p class="u-handle">@ {{ username() }}</p>
    </div>
    <mat-divider></mat-divider>

    <button mat-menu-item [routerLink]="['/profile', userId()]">
      <mat-icon>person_outline</mat-icon>
      <span>Profile</span>
    </button>

    <button mat-menu-item routerLink="/settings">
      <mat-icon>settings</mat-icon>
      <span>Settings</span>
    </button>
    <mat-divider></mat-divider>
    <button mat-menu-item (click)="logout()">
      <mat-icon color="warn">logout</mat-icon>
      <span>Sign out</span>
    </button>
  </mat-menu>
</nav>
