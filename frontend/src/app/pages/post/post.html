@if (loading) {
<div class="loading-state">
  <mat-spinner diameter="40"></mat-spinner>
</div>
} @else if (post) {

<!-- LAYOUT WRAPPER -->
<div class="post-page-layout">
  <!-- LEFT COLUMN: The Article -->
  <main class="article-container">
    <!-- 1. Article Header -->
    <header class="article-header">
      <h1 class="article-title">{{ post.title }}</h1>

      <!-- Author & Meta -->
      <div class="author-meta-block">
        <div class="author-info">
          <div class="author-avatar">
            <img
              [src]="
                post.author.avatarUrl
                  ? 'http://localhost:8080' + post.author.avatarUrl
                  : '/default-avatar.jpg'
              "
              alt="{{ post.author.username }}"
              onerror="this.src='/default-avatar.jpg'"
            />
          </div>
          <div class="meta-text">
            <div class="author-name" [routerLink]="['/profile', post.author.id]">
              {{ post.author.username }}
            </div>
            <div class="publish-date">
              <span>{{ post.createdAt | date : 'MMM d, y' }}</span>
            </div>
          </div>
        </div>

        <!-- Post Menu (Materialized in previous steps) -->
        @if (currentUserId) {
        <app-post-options-menu
          [postId]="post.id"
          [canEdit]="currentUserId == post.author.id || isAdmin"
          [canReport]="currentUserId != post.author.id && !isAdmin"
          (delete)="onDelete(post)"
          (report)="onReport(post.author.id)"
        ></app-post-options-menu>
        }
      </div>
    </header>

    <!-- 2. Main Media (Cover) -->
    @if (post.mediaUrl) {
    <figure class="article-feature-media">
      @if (post.mediaType == 'IMAGE') {
      <img [src]="'http://localhost:8080' + post.mediaUrl" alt="Feature image" />
      } @if (post.mediaType == 'VIDEO') {
      <video [src]="'http://localhost:8080' + post.mediaUrl" controls></video>
      }
    </figure>
    }

    <!-- 3. Article Body -->
    <section class="article-content">
      <div class="post-body">
        <markdown [data]="fullContentDisplay"></markdown>
      </div>

      @if (isLoadingChunks) {
      <div class="chunk-loading-indicator">
        <mat-spinner diameter="30"></mat-spinner>
      </div>
      }
      <div #scrollAnchor style="height: 20px; width: 100%"></div>
    </section>

    <!-- 4. Engagement Bar -->
    @if (!isAdmin) {
    <section class="engagement-bar">
      <div class="engagement-left">
        @if (currentUserId ) {
        <button
          mat-icon-button
          class="action-btn like-btn"
          [class.active]="post.likedByCurrentUser"
          (click)="toggleLike(post)"
          [matTooltip]="post.likedByCurrentUser ? 'Unlike' : 'Like'"
        >
          <mat-icon>{{ post.likedByCurrentUser ? 'favorite' : 'favorite_border' }}</mat-icon>
        </button>
        <span class="count-label">{{ post.likeCount }}</span>
        }

        <button mat-icon-button class="action-btn comment-trigger" matTooltip="Responses">
          <mat-icon>chat_bubble_outline</mat-icon>
        </button>
        <span class="count-label">{{ post.comments.length }}</span>
      </div>
    </section>
    }

    <div class="separator"></div>

    <!-- 5. Comments Section -->
    <section class="responses-section">
      <h3>Responses ({{ post.comments.length }})</h3>

      @if (currentUserId && !isAdmin) {
      <div class="add-response-box">
        <div class="user-avatar-small">
          <span>{{ post.author.username.charAt(0) | uppercase }}</span>
        </div>
        <div class="input-wrapper">
          <textarea
            placeholder="What are your thoughts?"
            [(ngModel)]="newComment"
            rows="1"
          ></textarea>
          @if (newComment) {
          <div class="input-actions">
            <button mat-button class="cancel-btn" (click)="newComment = ''">Cancel</button>
            <button mat-flat-button class="submit-btn" (click)="sendComment()">Respond</button>
          </div>
          }
        </div>
      </div>
      }

      <div class="response-list">
        @if (post.comments.length == 0) {
        <p class="empty-responses">No responses yet.</p>
        } @for (c of post.comments; track c) {
        <div class="response-item">
          <div class="response-header">
            <div class="response-author" [routerLink]="['/profile', c.author.id]">
              <img
                [src]="
                  c.author.avatarUrl
                    ? 'http://localhost:8080' + c.author.avatarUrl
                    : '/default-avatar.jpg'
                "
                onerror="this.src='/default-avatar.jpg'"
              />
              <span class="response-name">{{ c.author.username }}</span>
              <span class="response-date">{{ c.createdAt | date : 'MMM d' }}</span>
            </div>
          </div>
          <div class="response-body">
            <p>{{ c.text }}</p>
          </div>
        </div>
        }
      </div>
    </section>
  </main>

  <!-- RIGHT COLUMN: Sidebar -->
  @if (!isAdmin) {
  <aside class="sidebar-container">
    <app-suggested-users></app-suggested-users>
  </aside>
  }
</div>
} @else {
<div class="not-found">
  <h1>Post not found</h1>
  <a mat-button color="primary" routerLink="/">Back to home</a>
</div>
}
