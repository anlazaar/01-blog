<div class="login-page settings-page">
  <div class="login-container">
    <form [formGroup]="publicInfoForm" (ngSubmit)="onSubmit()">
      <!-- Header -->
      <div class="title">
        <h1>Profile Information</h1>
        <p>Update your photo and personal details.</p>
      </div>

      <!-- Profile Image Section -->
      <div class="profile-upload-section">
        <div class="avatar-wrapper">
          @if (avatarPreview()) {
          <img [src]="avatarPreview()" alt="Avatar Preview" />
          } @else {
          <div class="avatar-placeholder">
            <!-- Safe Access with Signals -->
            {{ user()?.username?.charAt(0) || '?' | uppercase }}
          </div>
          }
        </div>

        <div class="upload-actions">
          <button type="button" mat-stroked-button color="primary" (click)="fileInput.click()">
            Update photo
          </button>

          <input #fileInput type="file" (change)="onFileSelected($event)" accept="image/*" hidden />

          <span class="upload-hint">Recommended: Square JPG, PNG.</span>

          @if (fileError()) {
          <div class="error-msg">
            <small>{{ fileError() }}</small>
          </div>
          }
        </div>
      </div>

      <!-- Split Inputs -->
      <div class="form-row">
        <mat-form-field appearance="fill" class="half-width">
          <mat-label>First name</mat-label>
          <input matInput formControlName="firstname" />
          @if(publicInfoForm.controls.firstname.invalid) {
          <mat-error>First name is required</mat-error>
          }
        </mat-form-field>

        <mat-form-field appearance="fill" class="half-width">
          <mat-label>Last name</mat-label>
          <input matInput formControlName="lastname" />
          @if(publicInfoForm.controls.lastname.invalid) {
          <mat-error>Last name is required</mat-error>
          }
        </mat-form-field>
      </div>

      <div class="form-row single-col">
        <mat-form-field appearance="fill" class="full-width">
          <mat-label>Email</mat-label>
          <input matInput type="email" formControlName="email" />
          @if(publicInfoForm.controls.email.invalid) {
          <mat-error>Valid email is required</mat-error>
          }
        </mat-form-field>

        <mat-form-field appearance="fill" class="full-width">
          <mat-label>Username</mat-label>
          <input matInput formControlName="username" />
          @if(publicInfoForm.controls.username.invalid) {
          <mat-error>Username is required</mat-error>
          }
        </mat-form-field>

        <mat-form-field appearance="fill" class="full-width">
          <mat-label>Short Bio</mat-label>
          <textarea
            matInput
            formControlName="bio"
            rows="3"
            placeholder="Tell your story..."
          ></textarea>
          @if (publicInfoForm.controls.bio.invalid) {
          <mat-error>Bio is too long.</mat-error>
          }
        </mat-form-field>
      </div>

      <!-- Section Divider -->
      <div class="section-divider">
        <span>Security</span>
      </div>

      <div class="form-row single-col">
        <mat-form-field appearance="fill" class="full-width">
          <mat-label>Old Password</mat-label>
          <input matInput type="password" formControlName="oldpassword" />
        </mat-form-field>

        <mat-form-field appearance="fill" class="full-width">
          <mat-label>New Password</mat-label>
          <input matInput type="password" formControlName="password" />
          @if(publicInfoForm.controls.password.invalid) {
          <mat-error>Password must be at least 6 characters</mat-error>
          }
        </mat-form-field>
      </div>

      <div class="actions">
        <!-- Save Button -->
        <button
          mat-flat-button
          color="primary"
          class="save-btn"
          type="submit"
          [disabled]="publicInfoForm.invalid || publicInfoForm.pristine || isSubmitting()"
        >
          {{ isSubmitting() ? 'Saving...' : 'Save' }}
        </button>
      </div>
    </form>
  </div>
</div>
