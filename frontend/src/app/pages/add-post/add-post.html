<div class="editor-layout">
  <nav class="editor-nav">
    <div class="nav-left">
      <a routerLink="/" class="back-link">
        <fa-icon [icon]="faArrowLeft"></fa-icon> <span>Back to feed</span>
      </a>
      <span class="draft-status">
        {{ isEditMode ? 'Editing' : 'Drafting' }} {{ postForm.get('title')?.value || 'Untitled' }}
      </span>
    </div>

    <!-- Publish Action Area -->
    <div class="nav-right">
      @if (!isSubmitting) {
      <button
        class="draft-btn"
        (click)="onSaveDraft()"
        [disabled]="postForm.invalid || editorMediaLoading"
      >
        Save Draft
      </button>

      <button
        class="publish-btn"
        (click)="onPublish()"
        [disabled]="postForm.invalid || editorMediaLoading"
      >
        {{ isEditMode ? 'Update' : 'Publish' }}
      </button>
      } @if (isSubmitting) {
      <div class="publishing-status">
        <span class="status-text">Saving {{ uploadProgress }}%</span>
        <div class="progress-track">
          <div class="progress-fill" [style.width.%]="uploadProgress"></div>
        </div>
      </div>
      }
    </div>
  </nav>

  <div class="editor-container">
    @if (errorMessage) {
    <div class="error-banner">{{ errorMessage }}</div>
    }

    <form [formGroup]="postForm" [class.disabled-form]="isSubmitting || editorMediaLoading">
      <!-- COVER MEDIA AREA (Supports Image OR Video) -->
      <div class="cover-image-area">
        @if (!coverPreviewUrl) {
        <button type="button" class="add-cover-btn" (click)="triggerFileInput()">
          <fa-icon [icon]="faImage"></fa-icon> Add cover image or video
        </button>
        } @else {
        <div class="cover-preview">
          @if (isVideoType) {
          <video [src]="coverPreviewUrl" controls class="cover-media"></video>
          } @else {
          <img [src]="coverPreviewUrl" alt="Cover" class="cover-media" />
          }
          <button type="button" class="remove-cover-btn" (click)="removeCover()">Ã—</button>
        </div>
        }
        <!-- Accepts both types -->
        <input
          type="file"
          id="cover-upload"
          hidden
          (change)="onFileSelected($event)"
          accept="image/*, video/*"
        />
      </div>

      <textarea
        class="title-input"
        placeholder="Title"
        formControlName="title"
        rows="1"
        (input)="autoResize($event)"
      ></textarea>

      <!-- Hidden Input for Editor Images Only -->
      <input
        type="file"
        id="editor-image-upload"
        hidden
        accept="image/*"
        (change)="onEditorFileSelected($event)"
      />

      <!-- Toolbar (Text & Images Only) -->
      @if (editor) {
      <div class="tiptap-toolbar">
        <button
          type="button"
          (click)="editor.chain().focus().toggleBold().run()"
          [class.is-active]="editor.isActive('bold')"
        >
          <fa-icon [icon]="faBold"></fa-icon>
        </button>
        <button
          type="button"
          (click)="editor.chain().focus().toggleItalic().run()"
          [class.is-active]="editor.isActive('italic')"
        >
          <fa-icon [icon]="faItalic"></fa-icon>
        </button>
        <button
          type="button"
          (click)="editor.chain().focus().toggleStrike().run()"
          [class.is-active]="editor.isActive('strike')"
        >
          <fa-icon [icon]="faStrike"></fa-icon>
        </button>
        <button type="button" (click)="setLink()" [class.is-active]="editor.isActive('link')">
          <fa-icon [icon]="faLink"></fa-icon>
        </button>

        <div class="separator"></div>

        <button
          type="button"
          (click)="editor.chain().focus().toggleHeading({ level: 2 }).run()"
          [class.is-active]="editor.isActive('heading', { level: 2 })"
        >
          <fa-icon [icon]="faHeading"></fa-icon>
        </button>
        <button
          type="button"
          (click)="editor.chain().focus().toggleBlockquote().run()"
          [class.is-active]="editor.isActive('blockquote')"
        >
          <fa-icon [icon]="faQuote"></fa-icon>
        </button>
        <button
          type="button"
          (click)="editor.chain().focus().toggleCodeBlock().run()"
          [class.is-active]="editor.isActive('codeBlock')"
        >
          <fa-icon [icon]="faCode"></fa-icon>
        </button>

        <div class="separator"></div>

        <button type="button" (click)="triggerEditorImageInput()">
          <fa-icon [icon]="faImage"></fa-icon>
        </button>

        <!-- Video Button Removed -->

        <div class="separator"></div>

        <button
          type="button"
          (click)="editor.chain().focus().toggleBulletList().run()"
          [class.is-active]="editor.isActive('bulletList')"
        >
          <fa-icon [icon]="faListUl"></fa-icon>
        </button>
        <button
          type="button"
          (click)="editor.chain().focus().toggleOrderedList().run()"
          [class.is-active]="editor.isActive('orderedList')"
        >
          <fa-icon [icon]="faListOl"></fa-icon>
        </button>
        <button type="button" (click)="editor.chain().focus().setHorizontalRule().run()">
          <fa-icon [icon]="faMinus"></fa-icon>
        </button>

        <div class="separator"></div>

        <button
          type="button"
          (click)="editor.chain().focus().undo().run()"
          [disabled]="!editor.can().undo()"
        >
          <fa-icon [icon]="faUndo"></fa-icon>
        </button>
        <button
          type="button"
          (click)="editor.chain().focus().redo().run()"
          [disabled]="!editor.can().redo()"
        >
          <fa-icon [icon]="faRedo"></fa-icon>
        </button>
      </div>
      }

      <div class="tiptap-container" [class.loading]="editorMediaLoading">
        <tiptap-editor [editor]="editor"></tiptap-editor>
      </div>
    </form>
  </div>
</div>
