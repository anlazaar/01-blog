<div class="editor-layout">
  <!-- Navbar -->
  <nav class="editor-nav">
    <div class="nav-left">
      <a mat-button routerLink="/" class="back-link">
        <mat-icon>arrow_back</mat-icon> Back to feed
      </a>
      <!-- SIGNAL USAGE -->
      <span class="draft-status">
        {{ isEditMode() ? 'Editing' : 'Drafting' }} {{ postForm.get('title')?.value || 'Untitled' }}
      </span>
    </div>

    <!-- Actions -->
    <div class="nav-right">
      <!-- CONTROL FLOW @if -->
      @if (!isSubmitting()) {
      <button
        mat-button
        class="draft-btn"
        (click)="onSaveDraft()"
        [disabled]="postForm.invalid || editorMediaLoading()"
      >
        Save Draft
      </button>

      <button
        mat-flat-button
        color="primary"
        class="publish-btn"
        (click)="onPublish()"
        [disabled]="postForm.invalid || editorMediaLoading()"
      >
        {{ isEditMode() ? 'Update' : 'Publish' }}
      </button>
      } @if (isSubmitting()) {
      <div class="publishing-status">
        <span class="status-text">Saving {{ uploadProgress() }}%</span>
        <mat-progress-bar mode="determinate" [value]="uploadProgress()"></mat-progress-bar>
      </div>
      }
    </div>
  </nav>

  <div class="editor-container">
    @if (errorMessage()) {
    <div class="error-banner">{{ errorMessage() }}</div>
    }

    <form [formGroup]="postForm" [class.disabled-form]="isSubmitting() || editorMediaLoading()">
      <!-- COVER IMAGE AREA -->
      <div class="cover-image-area">
        @if (!coverPreviewUrl) {
        <button type="button" mat-button class="add-cover-btn" (click)="triggerFileInput()">
          <mat-icon>add_photo_alternate</mat-icon> Add cover image or video
        </button>
        } @else {
        <div class="cover-preview">
          @if (isVideoType) {
          <video [src]="coverPreviewUrl" controls class="cover-media"></video>
          } @else {
          <img [src]="coverPreviewUrl" alt="Cover" class="cover-media" />
          }
          <button mat-icon-button class="remove-cover-btn" (click)="removeCover()">
            <mat-icon>close</mat-icon>
          </button>
        </div>
        }
        <input
          type="file"
          id="cover-upload"
          hidden
          (change)="onFileSelected($event)"
          accept="image/*, video/*"
        />
      </div>

      <!-- TITLE -->
      <textarea
        class="title-input"
        placeholder="Title"
        formControlName="title"
        rows="1"
        (input)="autoResize($event)"
      ></textarea>

      <!-- HASHTAGS -->
      <div class="tags-container">
        <mat-form-field class="tag-form-field" appearance="fill">
          <mat-chip-grid #chipGrid aria-label="Enter tags">
            <!-- CONTROL FLOW @for -->
            @for (tag of tags(); track tag) {
            <mat-chip-row (removed)="removeTag(tag)">
              #{{ tag }}
              <button matChipRemove [attr.aria-label]="'remove ' + tag">
                <mat-icon>cancel</mat-icon>
              </button>
            </mat-chip-row>
            }

            <input
              #tagInput
              placeholder="Add a topic..."
              [formControl]="tagCtrl"
              [matChipInputFor]="chipGrid"
              [matAutocomplete]="auto"
              [matChipInputSeparatorKeyCodes]="separatorKeysCodes"
              (matChipInputTokenEnd)="addTag($event)"
              class="tag-input"
            />
          </mat-chip-grid>

          <mat-autocomplete #auto="matAutocomplete" (optionSelected)="selected($event)">
            <!-- Signal from filteredTags -->
            @for (tag of filteredTags(); track tag) {
            <mat-option [value]="tag"> #{{ tag }} </mat-option>
            }
          </mat-autocomplete>
        </mat-form-field>
      </div>

      <input
        type="file"
        id="editor-image-upload"
        hidden
        accept="image/*"
        (change)="onEditorFileSelected($event)"
      />

      <!-- TOOLBAR -->
      @if (editor) {
      <div class="tiptap-toolbar">
        <button
          type="button"
          mat-icon-button
          (click)="editor.chain().focus().toggleBold().run()"
          [class.is-active]="editor.isActive('bold')"
        >
          <mat-icon>format_bold</mat-icon>
        </button>
        <!-- (Rest of buttons remain similar, just ensuring template syntax is clean) -->
        <button
          type="button"
          mat-icon-button
          (click)="editor.chain().focus().toggleItalic().run()"
          [class.is-active]="editor.isActive('italic')"
        >
          <mat-icon>format_italic</mat-icon>
        </button>

        <div class="separator"></div>

        <button type="button" mat-icon-button (click)="triggerEditorImageInput()">
          <mat-icon>image</mat-icon>
        </button>

        <div class="separator"></div>

        <button
          type="button"
          mat-icon-button
          (click)="editor.chain().focus().undo().run()"
          [disabled]="!editor.can().undo()"
        >
          <mat-icon>undo</mat-icon>
        </button>
        <button
          type="button"
          mat-icon-button
          (click)="editor.chain().focus().redo().run()"
          [disabled]="!editor.can().redo()"
        >
          <mat-icon>redo</mat-icon>
        </button>
      </div>
      }

      <!-- EDITOR CONTENT -->
      <div class="tiptap-container" [class.loading]="editorMediaLoading()">
        <tiptap-editor [editor]="editor"></tiptap-editor>
      </div>
    </form>
  </div>
</div>
