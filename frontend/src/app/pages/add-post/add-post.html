<div class="editor-layout">
  <!-- Navbar -->
  <nav class="editor-nav">
    <div class="nav-left">
      <a mat-button routerLink="/" class="back-link">
        <mat-icon>arrow_back</mat-icon> Back to feed
      </a>
      <span class="draft-status">
        {{ isEditMode ? 'Editing' : 'Drafting' }} {{ postForm.get('title')?.value || 'Untitled' }}
      </span>
    </div>

    <!-- Actions -->
    <div class="nav-right">
      @if (!isSubmitting) {
      <button
        mat-button
        class="draft-btn"
        (click)="onSaveDraft()"
        [disabled]="postForm.invalid || editorMediaLoading"
      >
        Save Draft
      </button>

      <button
        mat-flat-button
        color="primary"
        class="publish-btn"
        (click)="onPublish()"
        [disabled]="postForm.invalid || editorMediaLoading"
      >
        {{ isEditMode ? 'Update' : 'Publish' }}
      </button>
      } @if (isSubmitting) {
      <div class="publishing-status">
        <span class="status-text">Saving {{ uploadProgress }}%</span>
        <mat-progress-bar mode="determinate" [value]="uploadProgress"></mat-progress-bar>
      </div>
      }
    </div>
  </nav>

  <div class="editor-container">
    @if (errorMessage) {
    <div class="error-banner">{{ errorMessage }}</div>
    }

    <form [formGroup]="postForm" [class.disabled-form]="isSubmitting || editorMediaLoading">
      <!-- COVER IMAGE AREA -->
      <div class="cover-image-area">
        @if (!coverPreviewUrl) {
        <button type="button" mat-button class="add-cover-btn" (click)="triggerFileInput()">
          <mat-icon>add_photo_alternate</mat-icon> Add cover image or video
        </button>
        } @else {
        <div class="cover-preview">
          @if (isVideoType) {
          <video [src]="coverPreviewUrl" controls class="cover-media"></video>
          } @else {
          <img [src]="coverPreviewUrl" alt="Cover" class="cover-media" />
          }
          <button mat-icon-button class="remove-cover-btn" (click)="removeCover()">
            <mat-icon>close</mat-icon>
          </button>
        </div>
        }
        <input
          type="file"
          id="cover-upload"
          hidden
          (change)="onFileSelected($event)"
          accept="image/*, video/*"
        />
      </div>

      <!-- TITLE -->
      <textarea
        class="title-input"
        placeholder="Title"
        formControlName="title"
        rows="1"
        (input)="autoResize($event)"
      ></textarea>

      <!-- HIDDEN EDITOR UPLOAD -->
      <input
        type="file"
        id="editor-image-upload"
        hidden
        accept="image/*"
        (change)="onEditorFileSelected($event)"
      />

      <!-- TOOLBAR (Material Icons) -->
      @if (editor) {
      <div class="tiptap-toolbar">
        <button
          type="button"
          mat-icon-button
          (click)="editor.chain().focus().toggleBold().run()"
          [class.is-active]="editor.isActive('bold')"
        >
          <mat-icon>format_bold</mat-icon>
        </button>
        <button
          type="button"
          mat-icon-button
          (click)="editor.chain().focus().toggleItalic().run()"
          [class.is-active]="editor.isActive('italic')"
        >
          <mat-icon>format_italic</mat-icon>
        </button>
        <button
          type="button"
          mat-icon-button
          (click)="editor.chain().focus().toggleStrike().run()"
          [class.is-active]="editor.isActive('strike')"
        >
          <mat-icon>strikethrough_s</mat-icon>
        </button>
        <button
          type="button"
          mat-icon-button
          (click)="setLink()"
          [class.is-active]="editor.isActive('link')"
        >
          <mat-icon>link</mat-icon>
        </button>

        <div class="separator"></div>

        <button
          type="button"
          mat-icon-button
          (click)="editor.chain().focus().toggleHeading({ level: 2 }).run()"
          [class.is-active]="editor.isActive('heading', { level: 2 })"
        >
          <mat-icon>title</mat-icon>
        </button>
        <button
          type="button"
          mat-icon-button
          (click)="editor.chain().focus().toggleBlockquote().run()"
          [class.is-active]="editor.isActive('blockquote')"
        >
          <mat-icon>format_quote</mat-icon>
        </button>
        <button
          type="button"
          mat-icon-button
          (click)="editor.chain().focus().toggleCodeBlock().run()"
          [class.is-active]="editor.isActive('codeBlock')"
        >
          <mat-icon>code</mat-icon>
        </button>

        <div class="separator"></div>

        <button type="button" mat-icon-button (click)="triggerEditorImageInput()">
          <mat-icon>image</mat-icon>
        </button>

        <div class="separator"></div>

        <button
          type="button"
          mat-icon-button
          (click)="editor.chain().focus().toggleBulletList().run()"
          [class.is-active]="editor.isActive('bulletList')"
        >
          <mat-icon>format_list_bulleted</mat-icon>
        </button>
        <button
          type="button"
          mat-icon-button
          (click)="editor.chain().focus().toggleOrderedList().run()"
          [class.is-active]="editor.isActive('orderedList')"
        >
          <mat-icon>format_list_numbered</mat-icon>
        </button>
        <button
          type="button"
          mat-icon-button
          (click)="editor.chain().focus().setHorizontalRule().run()"
        >
          <mat-icon>horizontal_rule</mat-icon>
        </button>

        <div class="separator"></div>

        <button
          type="button"
          mat-icon-button
          (click)="editor.chain().focus().undo().run()"
          [disabled]="!editor.can().undo()"
        >
          <mat-icon>undo</mat-icon>
        </button>
        <button
          type="button"
          mat-icon-button
          (click)="editor.chain().focus().redo().run()"
          [disabled]="!editor.can().redo()"
        >
          <mat-icon>redo</mat-icon>
        </button>
      </div>
      }

      <div class="tiptap-container" [class.loading]="editorMediaLoading">
        <tiptap-editor [editor]="editor"></tiptap-editor>
      </div>
    </form>
  </div>
</div>
