<div class="home-layout">
  <!-- LEFT COLUMN: The Feed -->
  <main class="feed-container" [class.full-width]="isAdmin()">
    <!-- Feed Header -->
    <div class="feed-header">
      <div class="header-content">
        <!-- DYNAMIC TITLE -->
        <div class="title-section">
          @if (selectedTag()) {
          <h1 class="topic-title"><span class="topic-label">Topic:</span> #{{ selectedTag() }}</h1>
          <button mat-icon-button (click)="clearFilter()" matTooltip="Clear filter">
            <mat-icon>close</mat-icon>
          </button>
          } @else {
          <h1>{{ isAdmin() ? 'Published Post' : 'For you' }}</h1>
          }
        </div>

        <div class="header-actions">
          <!-- Only show Write button if not filtering and not admin -->
          @if (currentUserId() && !isAdmin() && !selectedTag()) {
          <a mat-flat-button color="primary" routerLink="/new-story" class="write-btn">Write</a>
          }
        </div>
      </div>
    </div>

    <!-- === LOADING STATE (Skeleton) === -->
    @if (loading()) {
    <div class="skeleton-list">
      @for (item of skeletonItems; track $index) {
      <div class="skeleton-item">
        <div class="skeleton-header">
          <div class="skeleton-avatar"></div>
          <div class="skeleton-line short"></div>
        </div>
        <div class="skeleton-content">
          <div class="skeleton-text-group">
            <div class="skeleton-line title"></div>
            <div class="skeleton-line body"></div>
          </div>
          <div class="skeleton-image"></div>
        </div>
      </div>
      }
    </div>
    }

    <!-- === REAL CONTENT === -->
    @else { @if (posts().length > 0) {
    <div class="posts-list">
      @for (p of posts(); track p.id) {
      <article class="post-item">
        <!-- 1. Meta Header -->
        <div class="post-meta-header">
          <div class="author-info" [routerLink]="['/profile', p.author.id]">
            <div class="author-avatar-placeholder">
              @if(p.author.avatarUrl) {
              <img
                [src]="'http://localhost:8080' + p.author.avatarUrl"
                class="avatar-img"
                [alt]="p.author.username"
              />
              } @else {
              {{ p.author.username.charAt(0) | uppercase }}
              }
            </div>
            <span class="author-name">{{ p.author.username }}</span>
            <span class="separator">Â·</span>
            <span class="post-date">{{ p.createdAt | date : 'MMM d' }}</span>
          </div>

          <!-- Options Menu (If logged in) -->
          @if (currentUserId()) {
          <app-post-options-menu
            [postId]="p.id"
            [canEdit]="currentUserId() === p.author.id || isAdmin()"
            [canReport]="currentUserId() !== p.author.id && !isAdmin()"
            (report)="onReport(p.author.id)"
            (delete)="onDelete(p)"
          ></app-post-options-menu>
          }
        </div>

        <!-- 2. Content (Clickable) -->
        <div class="post-content" [routerLink]="['/posts', p.id]">
          <div class="post-text">
            <h2 class="post-title">{{ p.title }}</h2>
            <p class="post-preview">{{ p.description }}</p>

            <!-- Tags -->
            @if (p.tags && p.tags.length > 0) {
            <div class="feed-tags">
              @for(t of p.tags; track t) {
              <span class="mini-tag">#{{ t }}</span>
              }
            </div>
            }
          </div>

          <!-- Media Preview -->
          @if (p.mediaUrl) {
          <div class="post-media">
            @if (p.mediaType === 'IMAGE') {
            <img [src]="'http://localhost:8080' + p.mediaUrl" alt="Cover" />
            } @else if (p.mediaType === 'VIDEO') {
            <video [src]="'http://localhost:8080' + p.mediaUrl" controls muted></video>
            }
          </div>
          }
        </div>

        <!-- 3. Footer Actions -->
        <div class="post-actions-footer">
          <div class="right-actions">
            @if (currentUserId()) {
            <button
              mat-icon-button
              (click)="toggleSave($event, p)"
              [matTooltip]="p.savedByCurrentUser ? 'Unsave' : 'Save story'"
              class="save-btn"
              [class.active]="p.savedByCurrentUser"
            >
              <mat-icon>{{ p.savedByCurrentUser ? 'bookmark' : 'bookmark_border' }}</mat-icon>
            </button>
            }
          </div>
        </div>

        <div class="post-divider"></div>
      </article>
      }
    </div>

    <!-- Load More Button -->
    @if (hasMorePosts()) {
    <div class="load-more-container">
      <button
        mat-stroked-button
        class="load-more-btn"
        (click)="loadMore()"
        [disabled]="loadingMore()"
      >
        {{ loadingMore() ? 'Loading...' : 'Show more stories' }}
      </button>
    </div>
    } @else {
    <div class="end-of-feed"><p>You're all caught up!</p></div>
    } } @else {
    <!-- EMPTY STATE -->
    <div class="empty-state">
      @if (selectedTag()) {
      <mat-icon class="empty-icon">label_off</mat-icon>
      <h2>No stories found for #{{ selectedTag() }}</h2>
      <button mat-button color="primary" (click)="clearFilter()">Back to all posts</button>
      } @else {
      <h2>No stories yet.</h2>
      }
    </div>
    } }
  </main>

  <!-- RIGHT COLUMN: Sidebar (Hidden for Admins) -->
  @if (!isAdmin()) {
  <aside class="sidebar-container">
    <div class="sticky-sidebar-wrapper">
      <app-popular-tags></app-popular-tags>
      <app-suggested-users></app-suggested-users>
    </div>
  </aside>
  }
</div>
